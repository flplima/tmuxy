name: lint and tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Install npm dependencies
        run: npm install

      # --- Formatting ---

      - name: Prettier check
        run: npx prettier --check src
        working-directory: packages/tmuxy-ui

      - name: Rust format check
        run: cargo fmt --check -p tmuxy-core -p tmuxy-server

      # --- Linting ---

      - name: ESLint
        run: npm run lint -w tmuxy-ui

      - name: ESLint (E2E tests)
        run: npm run lint:tests

      - name: Clippy
        run: |
          mkdir -p packages/tmuxy-ui/dist
          cargo clippy -p tmuxy-core -p tmuxy-server -- -D warnings

      # --- Type Check ---

      - name: TypeScript type check
        run: npx tsc --noEmit
        working-directory: packages/tmuxy-ui

  tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      # Build tmux 3.5a from source (Ubuntu apt has 3.4; control mode differs)
      - name: Install tmux 3.5a
        run: |
          sudo apt-get update
          sudo apt-get install -y libevent-dev libncurses-dev bison
          curl -sL https://github.com/tmux/tmux/releases/download/3.5a/tmux-3.5a.tar.gz | tar xz
          cd tmux-3.5a && ./configure && make -j$(nproc) && sudo make install
          cd .. && rm -rf tmux-3.5a
          tmux -V

      - name: Install npm dependencies
        run: npm install

      - name: Install Chromium
        run: npx playwright install chromium --with-deps

      # --- Unit Tests ---

      - name: Vitest
        run: npm test -- --run

      # --- Build ---

      - name: Build frontend
        run: VITE_E2E=true npm run build -w tmuxy-ui

      - name: Build server
        run: cargo build -p tmuxy-server

      # --- E2E Tests ---

      - name: Start server
        run: |
          PORT=9000 ./target/debug/tmuxy-server 2>/tmp/tmuxy-server.log &
          node -e "
            const start = Date.now();
            const timeout = 30000;
            const check = async () => {
              while (Date.now() - start < timeout) {
                try {
                  const res = await fetch('http://localhost:9000');
                  if (res.ok) { process.exit(0); }
                } catch {}
                await new Promise(r => setTimeout(r, 500));
              }
              process.exit(1);
            };
            check();
          "

      - name: "E2E: 1 – Input & Interaction"
        id: e2e1
        continue-on-error: true
        run: npx jest --forceExit tests/1-input-interaction.test.js

      - name: "E2E: 2 – Layout & Navigation"
        id: e2e2
        continue-on-error: true
        run: npx jest --forceExit tests/2-layout-navigation.test.js

      - name: "E2E: 3 – Rendering & Protocols"
        id: e2e3
        continue-on-error: true
        run: npx jest --forceExit tests/3-rendering-protocols.test.js

      - name: "E2E: 4 – Session & Connectivity"
        id: e2e4
        continue-on-error: true
        run: npx jest --forceExit tests/4-session-connectivity.test.js

      - name: "E2E: 5 – Stress & Stability"
        id: e2e5
        continue-on-error: true
        run: npx jest --forceExit tests/5-stress-stability.test.js

      - name: Server logs (debug)
        if: failure() || steps.e2e1.outcome == 'failure' || steps.e2e2.outcome == 'failure' || steps.e2e3.outcome == 'failure' || steps.e2e4.outcome == 'failure' || steps.e2e5.outcome == 'failure'
        run: cat /tmp/tmuxy-server.log | tail -500

      - name: E2E results
        if: always()
        run: |
          echo "E2E 1: ${{ steps.e2e1.outcome }}"
          echo "E2E 2: ${{ steps.e2e2.outcome }}"
          echo "E2E 3: ${{ steps.e2e3.outcome }}"
          echo "E2E 4: ${{ steps.e2e4.outcome }}"
          echo "E2E 5: ${{ steps.e2e5.outcome }}"
          if [ "${{ steps.e2e1.outcome }}" = "failure" ] || [ "${{ steps.e2e2.outcome }}" = "failure" ] || [ "${{ steps.e2e3.outcome }}" = "failure" ] || [ "${{ steps.e2e4.outcome }}" = "failure" ] || [ "${{ steps.e2e5.outcome }}" = "failure" ]; then
            echo "::error::One or more E2E test suites failed"
            exit 1
          fi
