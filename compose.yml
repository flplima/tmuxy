services:
  tmuxy-dev:
    build: .
    image: tmuxy-dev
    network_mode: host
    init: true          # Proper init process to reap zombie processes
    pids_limit: 50000   # Safety buffer for process count
    stdin_open: true
    tty: true
    user: user
    working_dir: /workspace
    volumes:
      # Project workspace
      - .:/workspace
      # Container config files
      - ./docker:/home/user/docker:ro
      # Dotfiles scripts (tmux-run, etc.)
      - ~/dotfiles/scripts:/home/user/dotfiles/scripts:ro
      # Claude config (auth and settings - .claude.json has onboarding state)
      - ~/.claude:/home/user/.claude
      - ~/.claude.json:/home/user/.claude.json
      # SSH keys for git
      - ~/.ssh:/home/user/.ssh:ro
      # GitHub CLI auth
      - ~/.config/gh:/home/user/.config/gh:ro
      # Cargo cache for faster builds
      - tmuxy-cargo-registry:/usr/local/cargo/registry
      - tmuxy-cargo-git:/usr/local/cargo/git
    environment:
      - CHROME_CDP_URL=http://localhost:9222
      - TMUX_SESSION=dev
    security_opt:
      - no-new-privileges:true
    shm_size: 1g
    mem_limit: 6g
    command: bash -c "npm start && claude --dangerously-skip-permissions"

volumes:
  tmuxy-cargo-registry:
  tmuxy-cargo-git:
